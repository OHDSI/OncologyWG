/* uses placeholders
   __schema__ - the schema containing the results from the user
   __cdm_schema__ - the schema containing the vocabulary tables (concept, etc.)
*/

/*****************************************************
* Analysis
*****************************************************/
-- temp tables

-- Roll-up for cancers
drop table if exists cancer_type;
create temp table cancer_type (
  p int,
  t_name varchar(50),
  concept_id int
);
insert into cancer_type (p, t_name, concept_id) values
(1, 'Esophagus', 4181343),
(2, 'Stomach', 443387),
(3, 'small intestine', 443397),
(4, 'Large intestine', 443396),
(5, 'Liver', 4246127),
(6, 'Biliary tract', 4181345),
(7, 'Pancreas', 4180793),
(8, 'Head and neck', 4114222),
(9, 'Lung and respiratory tract', 40493428),
(10, 'Thymus', 36673515),
(11, 'Mesothelioma', 4116069),
(12, 'Kaposi sarcoma', 434584),
(13, 'Thyroid', 4178976),
(14, 'Melanoma', 4162276),
(15, 'Skin', 4155297),
(16, 'Adrenal gland', 4181328),
(18, 'Meninges', 4177240),
(19, 'Breast', 4112853),
(20, 'Brain', 443588),
(21, 'CNS', 4155285),
(22, 'Nervous system', 4157331),
(23, 'Endocrine gland', 4156115),
(24, 'Kidney', 196653),
(25, 'Ovary', 4181351),
(26, 'Placenta', 36617597),
(27, 'Prostate', 4163261),
(28, 'Renal pelvis', 4181357),
(29, 'T-cell or NK-cell', 4227653),
(30, 'Follicular non-Hodgkin''s', 4147411),
(31, 'Diffuse non-Hodgkin''s', 4003830),
(32, 'Multiple myeloma', 437233),
(33, 'Lymphoid leukemia', 132853),
(34, 'Myeloid leukemia', 140666),
(35, 'Monocytic leukemia', 321526),
(36, 'Bladder', 197508),
(37, 'Cervix', 198984),
(38, 'Uterus', 197230),
(39, 'Urinary system', 4169598),
(40, 'Female genital', 4177244),
(41, 'Male genital', 4181487),
(42, 'Immunoproliferative', 4003834),
(43, 'Hodgkin''s', 4038835),
(44, 'Other Non-Hodgkin''s', 4038838),
(45, 'Other Leukemia', 317510),
(46, 'Lymphoid hemopoietic', 4147164),
(47, 'mediastinum', 4181484),
(48, 'Peritoneum', 4089665),
(49, 'Bone', 443564),
(50, 'Cartilage', 444203),
(51, 'Soft tissue', 4153882),
(52, 'Unknown origin', 4114221)
;


/*********************
Analysis General
*********************/

-- overall counts
-- used to be "01 Records and concepts in source and standard.csv"
-- was also in temp table general_t_cnts
delete from __schema__.records_and_concepts_in_source_and_standard;

insert into __schema__.records_and_concepts_in_source_and_standard
select partner, p.cnt as size, sum(g.cnt) as t_records, round(sum(g.cnt)*1.0/p.cnt, 4) as records_patient, count(distinct(source)) as t_source, 
  round(count(distinct(source))*1.0/p.cnt, 4) as source_patient, count(distinct(standard)) as t_standard, round(count(distinct(standard))*1.0/p.cnt, 4) as standard_patient
from __schema__.general g
join __schema__.patient p using(partner)
group by partner, p.cnt;

-- 2. Count number of records per domain
-- used to be "02 Number of records per domain.csv"
delete from __schema__.number_of_records_per_domain;

insert into __schema__.number_of_records_per_domain
select partner, domain, records, round(records*1.0/t_records, 4) as "records_%", sources+standards as concepts, round((sources+standards)*1.0/(t_source+t_standard), 4) as "concept_%" 
from (
  select partner, case domain 
      when 'i' then 'Episode'
      when 'd' then 'Drug'
      when 'e' then 'Device'
      when 'p' then 'Procedure'
      when 'c' then 'Condition'
      when 'o' then 'Observation'
      when 'm' then 'Measurement'
      when 'v' then 'Meas Value'
      else ''
    end as domain, 
    sum(cnt) as records, count(distinct(source)) as sources, count(distinct(standard)) as standards
  from __schema__.general
  group by partner, domain
) a join __schema__.records_and_concepts_in_source_and_standard using(partner)
order by 1, 4 desc;

-- 3. Count number of records per vocabulary, domain
-- used to be "03 Number of records per vocabulary.csv"
delete from __schema__.number_of_records_per_vocabulary;

insert into __schema__.number_of_records_per_vocabulary
select partner, domain, vocabulary, records, round(records*1.0/t_records, 4) as "records_%", sources+standards as concepts, round((sources+standards)*1.0/(t_source+t_standard), 4) as "concept_%" 
from (
  select partner, vocabulary_id as vocabulary, case domain 
      when 'i' then 'Episode'
      when 'd' then 'Drug'
      when 'e' then 'Device'
      when 'p' then 'Procedure'
      when 'c' then 'Condition'
      when 'o' then 'Observation'
      when 'm' then 'Measurement'
      when 'v' then 'Meas Value'
      else ''
    end as domain,
    sum(cnt) as records, count(distinct(source)) as sources, count(distinct(standard)) as standards
  from __schema__.general
  join __cdm_schema__.concept on concept_id=standard
  group by partner, domain, vocabulary_id
) a join __schema__.records_and_concepts_in_source_and_standard using(partner) 
order by 1, 2, 3;


/* 5. Rolled-up tumor types for each partner
   We can't restrict the query to only a single partner here, because the "full join"
   enforces that each partner shows the same types. This means if a new partner joins
   that has a tumor type, which hasn't been in use with the previous partners, all partners
   will have to be added this new tumor type.
*/
-- used to be "05 Rolled-up tumor types for each partner.csv"
delete from __schema__.rolled_up_tumor_types_for_each_partner;

insert into __schema__.rolled_up_tumor_types_for_each_partner
with c_types as (
  select distinct partner, standard, first_value(t_name) over (partition by standard order by p) as cancer_type
  from __schema__.general
  join (select descendant_concept_id as standard, t_name, p from __cdm_schema__.concept_ancestor join cancer_type on concept_id=ancestor_concept_id) ancestor using(standard)
  where domain='c'
),
exist_types as (
  select distinct cancer_type from c_types
),
cst as (
  select partner, standard, records, cancer_type
  from (
    select partner, standard, sum(cnt) as records 
	from __schema__.general
	group by partner, standard
  ) rs
  join c_types using(partner, standard)  
), 
cst_summed as (
  select partner, cancer_type, sum(records) as records
  from cst
  group by partner, cancer_type
),
conditions as (
  select partner, sum(cnt) as t_records
  from __schema__.general where domain='c'
  group by partner
)
select partner, cancer_type, records, round(records*1.0/t_records, 4) as "record_%" 
from cst_summed 
join conditions using(partner) 
order by 1, 3 desc;


/***************************
Existence of source concepts
***************************/
-- 6. Count up
-- used to be "06 Count existing source concepts.csv"
delete from __schema__.count_existing_source_concepts;

insert into __schema__.count_existing_source_concepts
with cst as (
  select partner, source, case when source=0 then 'NULL' when source is null then 'NULL' when con.concept_id is null then 'Unknown' else 'Known' end as in_vocab, cnt 
  from (select partner, source, sum(cnt) as cnt from __schema__.general group by partner, source) g 
  left join __cdm_schema__.concept con on con.concept_id=source
), 
cst_summed as (
  select partner, in_vocab, sum(cnt) as records, count(distinct source) as concepts
  from cst
  group by partner, in_vocab
)
select partner, in_vocab, 
  records, case t_records when 0 then 1 else round(records/t_records, 4) end as "record_%", 
  concepts, case t_source when 0 then 1 else round(concepts*1.0/t_source, 4) end as "concept_%"
from cst_summed join __schema__.records_and_concepts_in_source_and_standard using(partner)
order by 1;

/***********************************
Standard concepts in standard fields
***********************************/
-- 10. count up
-- used to be "10 Standard concepts in standard fields.csv"
delete from __schema__.standard_concepts_in_standard_fields;

insert into __schema__.standard_concepts_in_standard_fields
with cst as (
  select partner, standard, case standard_concept when 'S' then 'standard' else 'source' end as concept, cnt 
  from __schema__.general join __cdm_schema__.concept on concept_id=standard
),
cst_summed as (
  select partner, concept, sum(cnt) as records, count(distinct standard) as concepts
  from cst
  group by partner, concept
)
select partner, concept, records, round(records*1.0/t_records, 4) as "record_%", concepts, round(concepts*1.0/t_standard, 4) as "concepts_%"
from cst_summed join __schema__.records_and_concepts_in_source_and_standard using(partner)
order by 1;


/********************************************************
Domain for standard concepts. Source records not relevant
********************************************************/

-- 12. count up
-- used to be "12 Domain for standard concepts.csv"
delete from __schema__.domain_for_standard_concepts;

insert into __schema__.domain_for_standard_concepts
with cst as (
  select partner, standard, concept_name, vocabulary_id, c.domain_id as shouldbe_domain, is_domain, case c.domain_id=is_domain when true then 'Correct' else 'Wrong' end as domain, sum(cnt) as cnt
  from (
    select partner, standard, case domain
      when 'i' then 'Episode'
      when 'd' then 'Drug'
      when 'e' then 'Device'
      when 'p' then 'Procedure'
      when 'c' then 'Condition'
      when 'o' then 'Observation'
      when 'm' then 'Measurement'
      when 'v' then 'Meas Value'
      else ''
    end as is_domain,
    cnt
    from __schema__.general
  ) g join __cdm_schema__.concept c on c.concept_id=g.standard
  where standard != 0
  group by partner, standard, concept_name, vocabulary_id, c.domain_id, is_domain -- same standard can be more than once b/o different sources
),
cst_summed as (
  select partner, domain, sum(cnt) as records, count(distinct standard) as concepts
  from cst
  group by partner, domain
)
select partner, domain, records, round(records*1.0/t_records, 4) as "record_%", concepts, round(concepts*1.0/t_standard, 4) as "concepts_%"
from cst_summed join __schema__.records_and_concepts_in_source_and_standard using(partner)
order by 1;


-- 12.5 report "wrong" concepts
-- used to be "12.5 Standard concept report.csv"
delete from __schema__.standard_concept_report;

insert into __schema__.standard_concept_report
with vocab_domain(vocabulary_id, domain_id) as (
  values
    ('Cancer Modifier', 'Measurement'),
    ('CDT', 'Device'),
    ('CDT', 'Procedure'),
    ('CPT4', 'Measurement'),
    ('CPT4', 'Observation'),
    ('CPT4', 'Procedure'),
    ('CVX', 'Drug'),
    ('HCPCS', 'Device'),
    ('HCPCS', 'Measurement'),
    ('HCPCS', 'Observation'),
    ('HCPCS', 'Procedure'),
    ('HemOnc', 'Episode'),
    ('ICD10', 'Condition'),
    ('ICD10PCS', 'Procedure'),
    ('ICD9Proc', 'Procedure'),
    ('ICDO3', 'Condition'),
    ('ICDO3', 'Observation'),
    ('LOINC', 'Meas Value'),
    ('LOINC', 'Measurement'),
    ('LOINC', 'Observation'),
    ('OMOP Extension', 'Observation'),
    ('OMOP Genomic', 'Measurement'),
    ('OPCS4', 'Procedure'),
    ('RxNorm', 'Drug'),
    ('RxNorm Extension', 'Drug'),
    ('SNOMED', 'Condition'),
    ('SNOMED', 'Device'),
    ('SNOMED', 'Meas Value'),
    ('SNOMED', 'Measurement'),
    ('SNOMED', 'Observation'),
    ('SNOMED', 'Procedure')
),
d(domain, is_domain) as (
  values
    ('i', 'Episode'),
    ('d', 'Drug'),
    ('e', 'Device'),
    ('p', 'Procedure'),
    ('c', 'Condition'),
    ('o', 'Observation'),
    ('m', 'Measurement'),
    ('v', 'Meas Value')
),
cst as (
  select partner, standard as concept_id, is_domain, 
    case 
      when standard=0 then 'Concept 0'
      when standard in (439386, 602269, 602272, 602275, 602969, 602970, 602971, 604547, 607048, 607049, 607050, 607051, 607053, 607054, 607055, 607056, 607057, 607058, 607059, 607060, 607061, 607062, 607063, 607064, 607065, 607066, 607067, 607068, 607069, 607280, 609311, 618469, 619436, 763789, 763790, 763791, 764843, 764844, 764845, 765765, 765766, 765927, 1616648, 3019275, 3031227, 3046328, 3047285, 3170524, 3178338, 3181947, 3186481, 3187219, 3190559, 3190559, 3191997, 3192778, 3194080, 3194224, 3194224, 3194496, 3194496, 3194774, 3195575, 3196195, 3196710, 3196710, 3198034, 3198481, 3655244, 3655245, 3655246, 3655247, 3655248, 4041008, 4054711, 4074238, 4077696, 4086970, 4120176, 4140825, 4157601, 4159955, 4160340, 4161012, 4161056, 4161667, 4164609, 4172456, 4183079, 4183080, 4183081, 4183082, 4183477, 4183904, 4183905, 4183906, 4183907, 4183908, 4184071, 4190072, 4190073, 4190075, 4194837, 4194838, 4196566, 4197325, 4204361, 4211973, 4213274, 4218365, 4218367, 4224785, 4233916, 4240067, 4240465, 4240570, 4240677, 4241072, 4241172, 4241295, 4241297, 4241299, 4245718, 4246265, 4246266, 4246267, 4250166, 4262472, 4263000, 4263220, 4263969, 4264626, 4264742, 4287178, 4287179, 4293037, 4294060, 4296693, 4297708, 4297709, 4314170, 35914128, 35917160, 35917178, 35917462, 35917557, 35917660, 35917676, 35917681, 35917685, 35917726, 35917728, 35917765, 35917822, 35917910, 35917927, 35917950, 35918077, 35918085, 35918197, 35918328, 35918437, 35918519, 35918542, 35918640, 35918842, 35919509, 35919618, 35919728, 35919765, 35919954, 35919970, 35919994, 35920028, 35920085, 35920126, 35920143, 35920146, 35920179, 35920224, 35920251, 35920260, 35920270, 35920343, 35920443, 35920539, 35920573, 35920610, 35920655, 35920824, 35920860, 35920989, 35921091, 35921109, 35921133, 35921137, 35921152, 35921160, 35921178, 35921183, 35921196, 35921230, 35921250, 35921264, 35921328, 35921353, 35921403, 35921405, 35921656, 35921661, 35921723, 35921747, 35921784, 35921870, 35921886, 35921901, 35922090, 35922140, 35922141, 35922150, 35922156, 35922174, 35922242, 35922266, 35922313, 35922337, 35922348, 35922355, 35922383, 35922400, 35922411, 35922447, 35922505, 35922591, 35922626, 35922682, 35922730, 35922904, 35922962, 35922988, 35922993, 35923048, 35923057, 35923088, 35923118, 35923132, 35923135, 35923201, 35923253, 35923337, 35923339, 35923388, 35923524, 35923553, 35923649, 35923741, 35923810, 35923852, 35923904, 35923915, 35923956, 35923977, 35923982, 35923983, 35924009, 35924031, 35924039, 35924130, 35924162, 35924188, 35924254, 35924257, 35924261, 35924267, 35924286, 35924411, 35924416, 35924479, 35924520, 35924543, 35924603, 35924622, 35924848, 35924881, 35924927, 35924949, 35925068, 35925128, 35925158, 35925362, 35925383, 35925568, 35925589, 35925615, 35925622, 35925690, 35925742, 35925857, 35925969, 35926128, 35926215, 35926216, 35926224, 35926278, 35926329, 35926364, 35926523, 35926594, 35926609, 35926836, 35926865, 35926871, 35926933, 35926948, 35926976, 35926992, 35927009, 35927163, 35927190, 35927208, 35927238, 35927240, 35927266, 35927285, 35927297, 35927351, 35927402, 35927464, 35927466, 35927674, 35927738, 35927757, 35927863, 35927939, 35927962, 35928107, 35928108, 35928255, 35928266, 35928291, 35928350, 35928360, 35928384, 35928409, 35928475, 35928496, 35928540, 35928541, 35928600, 35928621, 35928825, 35928832, 35928840, 35928955, 35928990, 35929019, 35929086, 35929088, 35929132, 35929144, 35929264, 35929318, 35929322, 35929414, 35929419, 35929474, 35929477, 35929479, 35929500, 35929512, 35929527, 35929742, 35929799, 35929801, 35929813, 35929857, 35929938, 35930010, 35930018, 35930198, 35930199, 35930331, 35930359, 35930379, 35930406, 35930456, 35930465, 35930532, 35930554, 35930575, 35930611, 35930625, 35930700, 35930717, 35930746, 35930783, 35930798, 35930874, 35930901, 35930915, 35930967, 35930977, 35930994, 35931147, 35931164, 35931194, 35931232, 35931301, 35931401, 35931460, 35931498, 35931542, 35931655, 35931686, 35931701, 35931717, 35931744, 35931796, 35931886, 35931985, 35932083, 35932257, 35932339, 35932470, 35932517, 35932624, 35932669, 35932747, 35932754, 35932784, 35932786, 35932956, 35932979, 35933036, 35933064, 35933129, 35933192, 35933195, 35933201, 35933238, 35933290, 35933300, 35933312, 35933317, 35933320, 35933340, 35933343, 35933399, 35933414, 35933450, 35933462, 35933469, 35933533, 35933606, 35933617, 35933638, 35933735, 35933764, 35934022, 35934034, 35934043, 35934104, 35934134, 35934154, 35934160, 35934218, 35934266, 35934292, 35934294, 35934374, 35934376, 35934400, 35934404, 35934440, 35934480, 35934510, 35934669, 35934680, 35934757, 35934768, 35934826, 35934875, 35934878, 35934974, 35935005, 35935009, 35935013, 35935147, 35935177, 35935326, 35935359, 35935396, 35935422, 35935509, 35935511, 35935545, 35935547, 35935582, 35935691, 35935721, 35935766, 35936070, 35936088, 35936096, 35936235, 35936237, 35936259, 35936291, 35936301, 35936327, 35936389, 35936429, 35936455, 35936559, 35936579, 35936591, 35936611, 35936624, 35936690, 35936705, 35936724, 35936833, 35936834, 35936839, 35936893, 35936942, 35936961, 35936979, 35937095, 35937128, 35937171, 35937204, 35937307, 35937340, 35937404, 35937557, 35937649, 35937667, 35937741, 35937750, 35937792, 35937813, 35937967, 35937993, 35938036, 35938083, 35938153, 35938161, 35938167, 35938215, 35938242, 35938257, 35938280, 35938376, 35938420, 35938653, 35938675, 35938716, 35938780, 35938994, 35939129, 35939253, 35939279, 35939323, 35939341, 35939364, 35939419, 35939481, 35939553, 35939570, 35939580, 35939601, 35939604, 35939647, 35939679, 35939717, 35939751, 35939852, 35939934, 35940098, 35940140, 35940143, 35940158, 35940179, 35940207, 35940308, 35940518, 35941810, 36210138, 36210185, 36210716, 36660173, 36660206, 40762603, 40762604, 40769829, 40769833, 45876292, 45878362, 45878621, 45878622, 45880086, 45880955, 45880956, 45881581, 45881582, 45882267, 45884263, 45884439, 45885239, 45885240) then 'Invalid grade'
      when standard in (718590, 3188117, 4106768, 4121054, 4121176, 4123017, 4127500, 4127501, 4127502, 4127503, 4127504, 4127505, 4127506, 4127606, 4127607, 4127608, 4127609, 4127610, 4128450, 4128451, 4128452, 4128453, 4128454, 4128455, 4128456, 4128457, 4129910, 4129912, 4129913, 4129914, 4129915, 4130406, 4130407, 4130408, 4130409, 4130410, 4130411, 4130412, 4130413, 4164075, 4193457, 4196439, 4196557, 4196564, 35919029, 35919047, 35919065, 35919075, 35919086, 35919088, 35919093, 35919110, 35919154, 35919191, 35919193, 35919204, 35919208, 35919230, 35919239, 35919243, 35919249, 35919280, 35919288, 35919295, 35919323, 35919331, 35919361, 35919378, 35919400, 35919421, 35919447, 35919467, 35919468, 35919469, 35919511, 35919521, 35919522, 35919532, 35919533, 35919535, 35919537, 35919551, 35919560, 35919571, 35919572, 35919580, 35919592, 35919625, 35919636, 35919649, 35919662, 35919676, 35919695, 35919707, 35919723, 35919732, 35919761, 35919772, 35919776, 35919810, 35919828, 35919835, 35919866, 35919875, 35919878, 35919887, 35919890, 35919901, 45876314, 45876314, 45876315, 45876315, 45876316, 45876316, 45876317, 45877986, 45878382, 45878382, 45878383, 45878383, 45878387, 45878395, 45878395, 45878643, 45878643, 45878651, 45878652, 45878652, 45878653, 45880108, 45880108, 45880109, 45880109, 45880112, 45880113, 45880978, 45880978, 45880979, 45880979, 45880980, 45880980, 45880981, 45880981, 45880986, 45880986, 45881605, 45881605, 45881606, 45881607, 45881608, 45881608, 45881619, 45882494, 45882495, 45882496, 45882496, 45882497, 45882497, 45882501, 45884283, 45884283, 45884284, 45884284, 45884285, 45884285, 46237068, 46237073, 46237073, 46237079, 46237081, 46237084, 46237084, 46237085, 46237085, 46237478, 46237479, 46237488, 46237997, 46237998, 46237998, 46237999, 46238000, 46238004, 46238005, 46238005) then 'Invalid stage'
      when standard in (40320642, 40352613, 40385299, 40320630, 40352607, 40390367, 40385463, 44801366, 40385466, 44797724, 40385831, 44795663, 40385468, 44799337, 40385832, 44797168, 40385467, 44797725, 40385833, 44801443, 4245720, 4270465, 4288239, 608940, 608946, 602334, 608979, 602333, 608866, 608930, 608931, 3575243, 4190930, 4299133, 40385748, 44833472, 4164481, 4163446, 35624616, 40390759, 602260, 44793886, 4228790, 4249699, 4240560, 4241933, 4241552, 4184079, 4183211, 4183478, 4241934, 4241060, 4241935, 4184076, 4183480, 759938, 764972, 44830990, 37018661, 4183632, 4182918, 4183744, 4182919, 4183745, 4183914, 4182920, 4183339, 4289377, 4281017, 4283615, 4281018, 4289098, 4283737, 4289378, 4281034, 4289687, 4283751, 4283752, 4182921, 4289516, 4283753, 4281036, 4281037, 4283880, 4289692, 40390374, 4289823, 4289521, 4289381, 4289248, 4283612, 4289093, 4289249, 4289094, 4283613, 4289095, 4289686, 4283877, 4289690, 4289519, 4281035, 4283878, 4283879, 4281160, 44801657, 4289824, 4281161, 4289825, 4289826, 4289523, 4289382, 4283741, 4289252, 4280898, 4289096, 4283743, 40385394, 4289386, 44800546, 40390740, 44799551, 4263459, 4265295, 2106924, 4194691, 4183217, 40756842, 1030309, 1004176, 1004177, 1004178, 1004179, 1030311, 1004182, 1004185, 1004186, 40769838, 40769842, 4099633, 37078044, 1030459, 1030460, 1030461, 45890688, 4281162, 4283744, 4283881, 4283882, 1567619, 4289524, 4283883, 1567622, 4281164, 1567624, 4283884, 1567626, 4281165, 1567628, 4281166, 4283885, 4283886, 1616704, 1618178, 915671, 1620371, 1620738, 1621181, 1014780, 4119047, 4289380, 4283888, 4183628, 4183335, 4183629, 4183630, 4183336, 4297801, 40520895, 4299325, 4200893, 4196260, 4196263, 4196259, 4198446, 4201020, 4201623, 4201014, 4196264, 4198445, 4198444, 4201617, 4196266, 4201621, 4201015, 4196262, 4201618, 4200894, 4196258, 4201620, 4201622, 4263142, 3006575, 3007073, 3018082, 3031522, 3034923, 3042868, 3046131, 3046179, 3046523, 4196267, 4196261, 4297349, 4118499, 4119001, 4134624, 4120185, 4123148, 4120186, 4080545, 4112781, 4112490, 40320638, 4112777, 4112780, 4110019, 4112482, 4110013, 4166589, 4110135, 4123439, 40320621, 4112771, 40320623, 40320627, 40320622, 40320634, 4110134, 4112772, 40320633, 40381908, 43530694, 4110014, 40320631, 43530696, 4112770, 40320620, 43531596, 4162254, 37025385, 43530697, 4112491, 4112483, 4123440, 40320628, 4116348, 40320639, 40385751, 4112489, 4112774, 4111031, 4112776, 4116575, 4112773, 4116246, 4116577, 40320635, 40385736, 4112488, 4109233, 40456809, 4110018, 4112775, 4116576, 4112650, 4112779, 4110133, 4116578, 4145870, 4291148, 37019559, 3964807, 37040031, 37060116, 36684947, 36684950, 37077014, 3968377, 4104214, 432631, 36684946, 37042857, 4084577, 4126828, 4084147, 765459, 763113, 762892, 763111, 762895, 1034401, 762896, 763116, 763001, 763118, 763117, 763115, 763103, 765662, 762905, 763124, 763125, 763123, 763122, 765863, 765906, 762902, 762903, 765864, 765512, 762904, 763130, 763131, 763132, 763134, 763133, 763128, 763129, 37016150, 37018877, 37208188, 2618018, 2618020, 2618019, 2618021, 2618022, 2618032, 2618036, 2618037, 2618034, 2618035, 4313066, 2618045, 2618009, 2617997, 2617998, 2617999, 4004515, 4157460, 4129285, 40287680, 4129938, 2618000, 4134634, 2618002, 2618047, 2618048, 2618049, 2618039, 2618040, 2618041, 2618016, 2618011, 2618012, 2618013, 2618066, 2618067, 2618028, 2618003, 37081416, 45571543, 3663237, 4129622, 4029023, 37111473, 4224153, 4160907, 4223201, 4265009, 4287478, 4168514, 602256, 4288669, 4223202, 4264263, 4188640, 4298500, 45768670, 4164018, 4215394, 4287188, 4141536, 4249709, 4246703, 4215393, 4216012, 4245129, 4263799, 4265302, 4161544, 4286895, 4264288, 4216013, 4219028, 4139997, 4253004, 4264600, 4245942, 4219190, 4264861, 4245130, 4187867, 4336816, 40552094, 4230027, 40552095, 4230028, 40552096, 4230150, 40552097, 4235556, 4158682, 4264455, 4264587, 4245838, 4227242, 4229871, 4265019, 4288096, 4288095, 4265020, 4160793, 4217716, 4299310, 4263653, 4245581, 4245241, 4297710, 4288685, 46270968, 4299198, 4287483, 4263798, 4264264, 4262994, 4246388, 4245127, 4160795, 4246370, 4287031, 4163561, 4262741, 4264120, 4187864, 4263146, 4164165, 4187865, 4129935, 4264121, 4160794, 4158683, 4265021, 4264588, 4262995, 4246389, 4245128, 4216801, 4187866, 4295631, 4263007, 4244835, 4265024, 4295517, 4298501, 4263130, 4288686, 4160904, 4263654, 4245940, 4160905, 4262993, 4262992, 4262742, 4262996, 4164472, 4263655, 4245941, 4295632, 4300130, 4265025, 4293155, 4245600, 4158684, 4245481, 4246160, 4158685, 4160906, 37016740, 764971, 4221383, 4164162, 4288237, 4265421, 4221086, 4287475, 4213276, 4245114, 4288238, 4219605, 4221386, 4287632, 4221518, 4163438, 4257442, 4299134, 40385732, 604497, 36712980, 36716990, 759982, 608941, 608928, 600834, 608942, 608927, 608852, 3519757, 4091627, 3532988, 4091629, 3567548, 4097419, 35206322, 3582188, 4094400, 3531110, 4091754, 3565761, 4091632, 4097418, 3582243, 4097423, 3582155, 4245947, 3531227, 4096824, 3519758, 4097413, 3531231, 4094401, 3582586, 4091624, 3532224, 4094395, 3582102, 4091633, 3582588, 4091626, 3531487, 4096826, 3531448, 4094398, 3519478, 4091631, 3519466, 4097420, 3531229, 4096825, 35206323, 3582241, 4091757, 3582354, 4097416, 3582242, 4097422, 3582416, 4097415, 3531442, 4097417, 35206321, 44821737, 3571014, 4091634, 3531837, 4094402, 35206324, 44833307, 3531488, 4094403, 3566636, 4091628, 35206320, 44834501, 3582070, 4096823, 35206326, 1567618, 3573598, 4153429, 37093670, 44836847, 3531489, 4096828, 3531490, 4091758, 44821738, 3530937, 4097411, 35206319, 3582590, 4097414, 44832135, 44829821, 35206325, 44828745, 44836848, 3582755, 4096821, 3531160, 4097424, 3519754, 4097412, 3582126, 4096822, 3569520, 4097421, 3531836, 4091756, 3582519, 4094396, 3582383, 46271138, 4096827, 3519756, 46273704, 4091625, 3582756, 4094394, 4262748, 3582211, 4094277, 3531230, 4091755, 3531447, 4094397, 3531564, 36684856, 4094276, 4263144, 3582520, 45771486, 4091630, 3582103, 4094399, 37093674, 37093675, 4263814, 37093673, 37093676, 37093672, 37093678, 37093671, 37093677, 1567614, 45542633, 45552289, 45542632, 45600534, 45532941, 45532940, 3542229, 4117043, 192269, 46271139, 3542169, 4111032, 4113113, 4266491, 3661467, 4300779, 46270936, 4114341, 3535048, 4111387, 608945, 619828, 608947, 37093681, 4312037, 4311630, 4311631, 4312038, 4312039, 4312699, 4311632, 4311633, 4246251, 193144, 1567630, 37081411, 44828746, 4246253, 4312040, 4311634, 4312700, 4312041, 35610151, 4312701, 4312148, 4246347, 4312702, 4312149, 4312703, 4246349, 40651438, 4311635, 4246350, 4311636, 4246351, 4027231, 4181016, 4287028, 4312150, 4312151, 442252, 4162133, 4246352, 4311637, 4312705, 36712822, 760916, 766340, 4311638, 4312802, 45600527, 1567625, 37081405, 4312276, 4311746, 40651453, 4312152, 4311747, 4312803, 4246354, 4246355, 4312804, 4312805, 4246356, 4246357, 4246358, 40651896, 4220182, 4311756, 4312165, 4312820, 4312166, 4311757, 4312821, 4246367, 4311758, 4311759, 4312167, 4266182, 4312275, 4246368, 4246369, 4311760, 4312277, 78097, 45552285, 40651916, 37081409, 44834502, 4246450, 45552286, 4312278, 4312279, 4312823, 4311762, 4246451, 45557016, 37081407, 378087, 44836851, 3567182, 4091764, 46271141, 4312280, 603292, 46271142, 44835686, 45542630, 4312824, 4312281, 4312284, 4246452, 4312282, 4246453, 4246454, 4312283, 4312285, 4312825, 4312934, 4312935, 4246455, 4312936, 4312287, 4312937, 4312286, 4312288, 4312938, 4312289, 4312290, 45537843, 4312291, 4311763, 4312939, 4246457, 4091766, 4312940, 4311764, 4246458, 4312293, 35610160, 4312941, 4247943, 4247944, 4247945, 35610158, 4311765, 40385369, 36683301, 4312943, 4247946, 4311766, 37093680, 37093679, 4312945, 4312946, 4311767, 4311768, 4312947, 4247947, 35610150, 35610159, 4311875, 4311876, 35610155, 4312295, 442188, 40385363, 4312296, 4311877, 4312297, 4247949, 4311878, 4311879, 4312299, 4312948, 4096952, 4312949, 4312950, 4311880, 4312300, 4312951, 4312952, 4311881, 4312301, 4312954, 4312955, 4312956, 4312957, 4312302, 140960, 201240, 4312303, 4313077, 4247960, 4311895, 4312423, 4313078, 4311896, 4311897, 4312013, 4312014, 4312015, 4247961, 4313079, 4247962, 608735, 44836852, 4312425, 4313080, 4313081, 4312426, 4247963, 4312427, 4247964, 4247965, 4312016, 4313082, 4247966, 4313083, 4312017, 4247967, 4312018, 4312429, 4248055, 4313085, 4313086, 4313087, 4248056, 4248057, 40385365, 4313088, 4312019, 35610157, 4312020, 194585, 4313089, 4248058, 4313090, 4248059, 4248060, 35610162, 35610148, 4312430, 4312022, 192568, 4312023, 4312024, 200959, 439751, 4248061, 4248062, 4248063, 4248064, 4313091, 4313092, 40385364, 4312540, 4248065, 196053, 44824037, 37081404, 4248066, 4248067, 4302810, 40464349, 40645478, 4313206, 4308759, 200348, 3543784, 37081399, 40385367, 40492474, 44835683, 3519482, 4091760, 4248068, 4313207, 4248069, 4313208, 4312026, 40651924, 4313209, 4312027, 4312028, 4313210, 601143, 45605289, 602331, 608981, 4281024, 605437, 4313211, 45552281, 46273652, 4281027, 45571541, 4128110, 4313212, 4313788, 607797, 4312542, 4248070, 4313789, 198700, 37081401, 44806773, 4313214, 4313215, 4312543, 4312544, 42709760, 4312545, 4312546, 4313216, 4312547, 46271211, 4248071, 254591, 1567620, 37081394, 44832136, 318096, 36713026, 440341, 442183, 442182, 320342, 442181, 36717298, 434298, 4248073, 4248074, 442178, 442177, 4315537, 4313791, 35610154, 4312548, 4315538, 4248076, 4313792, 434875, 35206327, 37081395, 44829822, 4315539, 4313793, 4315540, 4312549, 4248077, 4248078, 4312550, 4248079, 4248182, 4315541, 4313794, 4312551, 4313795, 4312552, 4315542, 4248081, 4248082, 4313796, 4312553, 4312554, 4313797, 4315543, 4312555, 4315544, 4313798, 4312556, 4248183, 4315545, 4055132, 40646016, 4313799, 4315547, 373425, 4248184, 4248185, 4312557, 4312558, 4313801, 4248186, 4248187, 4312559, 4248189, 4314487, 4248190, 4312560, 4313802, 37081402, 1567627, 37081408, 1567621, 37081397, 1567623, 37081403, 3519525, 4096948, 44836849, 3532360, 4091765, 44833309, 45532937, 3530935, 4096829, 44824036, 45557015, 3583608, 4094407, 40385759, 1567631, 3541083, 4154631, 37081412, 40385752, 44826416, 44828747, 44836850, 45532939, 3519755, 4096950, 3519484, 4091761, 44835685, 199752, 1567629, 37081410, 44834503, 4315548, 4248191, 4248192, 4315550, 4315552, 4315553, 4248193, 4315657, 4313803, 4248194, 4313911, 35610147, 4248195, 4313912, 4312561, 4313913, 4312562, 4248197, 4315658, 4315659, 4312563, 4248198, 4313914, 4313915, 4313916, 4313917, 4313918, 4315661, 4248199, 4248200, 4315805, 4315662, 4313919, 4315663, 4311208, 4312564, 4311209, 4311210, 72266, 35206328, 37081396, 44833308, 4311211, 4313920, 4313921, 4313922, 4311212, 4315664, 4314336, 4311320, 4312012, 4315666, 4314337, 4315667, 4311321, 4314338, 4315668, 4313924, 4311322, 4314339, 4311323, 4313925, 442174, 40385370, 4315670, 37081393, 4147162, 44819442, 40385360, 3531492, 4096949, 253717, 4311324, 4315671, 4314340, 4315672, 4315806, 196925, 37081400, 44835684, 3563896, 4097425, 4314341, 4311326, 601141, 45576343, 602332, 608980, 4289680, 602668, 4313926, 45537840, 46271143, 46270513, 4315673, 4281030, 45542629, 4314342, 4315674, 35610156, 4311327, 4314343, 4315675, 4315546, 4311328, 35206330, 35206331, 35206332, 4314344, 4301388, 764449, 1024759, 4032806, 4314345, 4314346, 4311329, 4283739, 4313927, 4313928, 4314347, 4314348, 4315677, 136354, 35206333, 37081406, 44821739, 3530971, 4091763, 36203174, 36203175, 36203182, 36205774, 45766888, 36206484, 36208335, 36209183, 36210146, 36210382, 36210725, 36310598, 36311298, 4314349, 4314350, 763049, 4313929, 4313930, 4315678, 4313931, 40385743, 4315679, 4311331, 4311332, 4313932, 4315680, 4315681, 4313933, 4313934, 4315683, 4315684, 40385738, 4315685, 4315686, 4313935, 4311333, 4091275, 37019862, 37020577, 37023301, 46270937, 37035551, 1314511, 1314515, 1314507, 37061519, 37070670, 37070802, 37074427, 37075956, 4314351, 4314352, 4091762, 4315793, 4094406, 3654229, 4311334, 4314353, 4311335, 42709758, 4315794, 4315795, 40385739, 4314354, 4313936, 4311336, 4311337, 4314355, 4097426, 4314356, 4314357, 4314358, 4313937, 40385740, 4314359, 42709759, 4314360, 4315796, 198371, 35206329, 37081398, 40385362, 44830989, 3565386, 4094405, 4311339, 602316, 602282, 4312944, 4314361, 4214371, 1619237, 1015305, 1031017, 4163000, 4315797, 4314362, 4315798, 4311340, 4315799, 4313939, 4315800, 4314046, 4314478, 4311341, 4314479, 4315801, 4314047, 4314480, 4314048, 4314049, 4314050, 4311342, 4314481, 442173, 4314052, 4311344, 4314053, 4314482, 4314483, 4311345, 4314484, 4314054, 37116980, 35610152, 4314055, 4314056, 4314485, 4314057, 4314058, 35610149, 4311346, 4311347, 4314059, 4315804, 4314486, 4314061, 4311348, 37081414, 37081413, 4314062, 4314063, 37081415, 4315807, 4311349, 4315808, 37116979, 3545386, 40548259, 4247948, 4311472, 4314488, 4315809, 40479359, 40479400, 40479812, 40479814, 4315810, 4314489, 40481946, 4314065, 4311473, 40385757, 40514771, 4315549, 4161021, 4314066, 4314490, 4313217, 4314067, 4314068, 4315811, 4314069, 4313218, 4314491, 4314070, 4314071, 4314492, 37037662, 40762537, 40762538, 40762539, 40762540, 40762543, 40762546, 40762547, 4299435, 36205776, 42527701, 42527713, 42527716, 42530626, 4315812, 4158910, 40385767, 45576342, 45605288, 45586027, 45561834, 45561833, 3006171, 45542628, 920115, 45595689, 42709761, 4314493, 1031084, 3042814, 4314072, 4314073, 4271714, 4314189, 1031116, 4314190, 4313220, 4313221, 4314191, 4313222, 4315813, 4314494, 78987, 4313223, 40651955, 4314495, 4313224, 4315814, 4313225, 4314496, 4314192, 4314193, 4314497, 4315815, 4314498, 4314194, 4315802, 4314195, 4314196, 37310458, 4314499, 4314500, 4314197, 4313226, 40385754, 40456812, 4314198, 4314199, 37093682, 432851, 44828764, 45566619, 4289393, 4289684, 761027, 44832171, 44831024, 44836885, 44828765, 44827595, 44827594, 1567613, 45890917, 45537842, 608896, 600854, 600835, 608929, 619829, 608944, 608933, 608855, 45552283, 600852, 608943, 608932, 600828, 608853, 759974, 759939, 764957, 764956, 4262152, 45576340, 45576341, 4235558, 4240688, 4241178, 4240690, 45600526, 4241546, 45600528, 4241305, 4241179, 4241306, 4161666, 4241181, 4253001, 4260320, 4312667, 4245698, 4287027, 4233917, 4162080, 3032133, 1015308, 1008948, 1008952, 4263143, 4245697, 4233629, 40387079, 40390328, 4123152, 4221342, 36208112, 37039548, 42530874, 42527710, 40664869, 937677, 3031099, 40762542, 40762545, 40762548, 4233788, 4233789, 2213285, 3036515, 36203173, 37038851, 36203183, 36206495, 37038788, 40539090, 4234267, 4240935, 4241926, 4241049, 4241054, 4240938, 4240939, 4241549, 4156593, 4240558, 4240446, 4241932, 4241057, 4184218, 4241050, 4241551, 4241058, 4240559, 4241059, 4240932, 4241815, 4240548, 4240933, 4241924, 4241929, 4240550, 4241927, 4241051, 4241928, 4241053, 4241055, 4240934, 4163763, 4241550, 4240553, 4241930, 4240554, 4240937, 4240552, 4241052, 4241931, 4240555, 4240549, 4241056, 4131424, 762893, 762894, 763110, 763114, 763102, 763100, 763099, 763126, 763127, 4164612, 40483198, 40480175, 607695, 607674, 607678, 603067, 602280, 607685, 607679, 607707, 607693, 607689, 603063, 607712, 607727, 607699, 607774, 607731, 602263, 607741, 607744, 607746, 607750, 607735, 607738, 607702, 607757, 607753, 607778, 607667, 607767, 607664, 607758, 607771, 607706, 607779, 607786, 607772, 607686, 607684, 607682, 4154265, 3662037, 2106805, 40664885, 4245599, 4263129, 4286893, 4286894, 3007727, 3008250, 3013189, 21013349, 37020347, 37073998, 36203178, 36206494, 37049880, 4155618, 3032528, 4240923, 4241434, 4241806, 4241807) then 'Invalid met or node'
      when is_domain!=domain_id then 'Wrong domain table'
      when vocab_domain.vocabulary_id is null then 'Wrong vocab for domain' 
      when standard_concept is null then 'Not standard concept'
      else null 
    end as critique, 
    sum(cnt) as cnt
  from __schema__.general 
  join __cdm_schema__.concept c on c.concept_id=standard
  join d using(domain)
  left join vocab_domain using(vocabulary_id, domain_id)
  where standard is not null
  group by partner, standard, is_domain, standard_concept, domain_id, vocab_domain.vocabulary_id
),
cst_summed as (
  select partner, critique, sum(cnt) as records, count(distinct concept_id) as concepts
  from cst
  group by partner, critique
)
select partner, critique, records, round(records*1.0/t_records, 4) as "record_%", concepts, round(concepts*1.0/t_standard, 4) as "concepts_%"
from cst_summed join __schema__.records_and_concepts_in_source_and_standard using(partner)
where critique is not null
order by 1, 2;


-- 12.6 Top standard concept errors
/* Why is partner selected into the intermediate table cst,
   when it's not in the final select? Does it even make a difference 
   in the result? The same applies to cnt*/
-- used to be "12.6 Top standard concept errors.csv"
delete from __schema__.top_standard_concept_errors;

insert into __schema__.top_standard_concept_errors
with stcm(source_id, standard_id) as (values
  (35919970, 1634371),
  (35929477, 1634371),
  (35933238, 1634371),
  (35921723, 1634752),
  (35926865, 1634752),
  (35929799, 1634752),
  (35920260, 1633749),
  (35929801, 1633749),
  (35930359, 1634371),
  (35930798, 1634371),
  (35937307, 1634371),
  (35921328, 1634752),
  (35934680, 1634752),
  (35936429, 1634752),
  (35927351, 1634371),
  (35933129, 1634371),
  (35939481, 1634371),
  (35924039, 1634752),
  (35925068, 1634752),
  (35921353, 1634752),
  (35926523, 1634371),
  (35932747, 1634371),
  (35923118, 1634371),
  (35935005, 1634752),
  (35931164, 1634752),
  (35934294, 1634752),
  (35924603, 1635587),
  (35930198, 1635587),
  (35920539, 36770413),
  (35924881, 36770413),
  (35935582, 36770413),
  (35937667, 36770413),
  (35922266, 1634085),
  (35933036, 1634085),
  (35934154, 1634085),
  (35935009, 1634085),
  (35923741, 1633749),
  (35926224, 1633749),
  (35933450, 1633749),
  (35919618, 1633749),
  (35919728, 1635792),
  (35921656, 1634371),
  (35930717, 1634371),
  (35939570, 1634371),
  (35933192, 1634752),
  (35935509, 1634752),
  (35938376, 1634752),
  (35934875, 1633749),
  (35938161, 1633749),
  (35940207, 1633749),
  (1634371, 35919970),
  (1634371, 35929477),
  (1634371, 35933238),
  (1634752, 35921723),
  (1634752, 35926865),
  (1634752, 35929799),
  (1633749, 35920260),
  (1633749, 35929801),
  (1634371, 35930359),
  (1634371, 35930798),
  (1634371, 35937307),
  (1634752, 35921328),
  (1634752, 35934680),
  (1634752, 35936429),
  (1634371, 35927351),
  (1634371, 35933129),
  (1634371, 35939481),
  (1634752, 35924039),
  (1634752, 35925068),
  (1634752, 35921353),
  (1634371, 35926523),
  (1634371, 35932747),
  (1634371, 35923118),
  (1634752, 35935005),
  (1634752, 35931164),
  (1634752, 35934294),
  (1635587, 35924603),
  (1635587, 35930198),
  (36770413, 35920539),
  (36770413, 35924881),
  (36770413, 35935582),
  (36770413, 35937667),
  (1634085, 35922266),
  (1634085, 35933036),
  (1634085, 35934154),
  (1634085, 35935009),
  (1633749, 35923741),
  (1633749, 35926224),
  (1633749, 35933450),
  (1633749, 35919618),
  (1635792, 35919728),
  (1634371, 35921656),
  (1634371, 35930717),
  (1634371, 35939570),
  (1634752, 35933192),
  (1634752, 35935509),
  (1634752, 35938376),
  (1633749, 35934875),
  (1633749, 35938161),
  (1633749, 35940207),
  (4183079, 1634752),
  (4241072, 36768755),
  (4287179, 1635792),
  (4041008, 1634752),
  (4183906, 1633749),
  (764845, 1633987),
  (4246267, 1633749),
  (4120176, 1635792),
  (4183477, 1634371),
  (764844, 1634191),
  (4184071, 1633749),
  (4204361, 1634371),
  (4241297, 36769109),
  (4190072, 36769737),
  (439386, 36769666),
  (4190075, 36770626),
  (4204361, 1634371),
  (4241297, 36769109),
  (4190073, 36768162),
  (4264742, 1633749),
  (4183905, 1634752),
  (4240067, 36769257),
  (4233916, 1635249),
  (4183081, 1634371),
  (4246266, 1634371),
  (4241299, 1634750),
  (3194496, 1635792),
  (4314170, 1635838),
  (4263969, 1634752),
  (4194837, 1634085),
  (4241172, 1634207),
  (4241295, 1635587),
  (4240677, 1635449),
  (4183080, 1635792),
  (764843, 1635131),
  (4194838, 1635587),
  (4183904, 1634371),
  (4183907, 1635792),
  (4161012, 1634085),
  (4183908, 1634752),
  (4183082, 1633749),
  (4240570, 1634085),
  (3655244, 1633550),
  (3655245, 1633826),
  (3655246, 1634459),
  (3655247, 1635079),
  (3655248, 1635009),
  (4074238, 1633655),
  (4140825, 1635475),
  (4211973, 1633844),
  (4224785, 1634230),
  (4172456, 1634230),
  (4263220, 1634230),
  (4250166, 1634230),
  (4240465, 1633687),
  (1634752, 4183079),
  (36768755, 4241072),
  (1635792, 4287179),
  (1634752, 4041008),
  (1633749, 4183906),
  (1633987, 764845),
  (1633749, 4246267),
  (1635792, 4120176),
  (1634371, 4183477),
  (1634191, 764844),
  (1633749, 4184071),
  (1634371, 4204361),
  (36769109, 4241297),
  (36769737, 4190072),
  (36769666, 439386),
  (36770626, 4190075),
  (1634371, 4204361),
  (36769109, 4241297),
  (36768162, 4190073),
  (1633749, 4264742),
  (1634752, 4183905),
  (36769257, 4240067),
  (1635249, 4233916),
  (1634371, 4183081),
  (1634371, 4246266),
  (1634750, 4241299),
  (1635792, 3194496),
  (1635838, 4314170),
  (1634752, 4263969),
  (1634085, 4194837),
  (1634207, 4241172),
  (1635587, 4241295),
  (1635449, 4240677),
  (1635792, 4183080),
  (1635131, 764843),
  (1635587, 4194838),
  (1634371, 4183904),
  (1635792, 4183907),
  (1634085, 4161012),
  (1634752, 4183908),
  (1633749, 4183082),
  (1634085, 4240570),
  (1633550, 3655244),
  (1633826, 3655245),
  (1634459, 3655246),
  (1635079, 3655247),
  (1635009, 3655248),
  (1633655, 4074238),
  (1635475, 4140825),
  (1633844, 4211973),
  (1634230, 4224785),
  (1634230, 4172456),
  (1634230, 4263220),
  (1634230, 4250166),
  (1633687, 4240465),
  (45878621, 1634371),
  (45878622, 1635792),
  (45880956, 1634752),
  (45880086, 1633749),
  (45880955, 36768423),
  (45881581, 36770667),
  (45885239, 1634371),
  (45885240, 1634752),
  (45884439, 1633749),
  (45882267, 1635792),
  (3047285, 734341),
  (36210716, 1634752),
  (36210185, 1634371),
  (1634371, 45878621),
  (1635792, 45878622),
  (1634752, 45880956),
  (1633749, 45880086),
  (36768423, 45880955),
  (36770667, 45881581),
  (1634371, 45885239),
  (1634752, 45885240),
  (1633749, 45884439),
  (1635792, 45882267),
  (734341, 3047285),
  (1634752, 36210716),
  (1634371, 36210185),
  (3194496, 1635792),
  (3198034, 1634085),
  (3194774, 1634085),
  (3194080, 1634085),
  (3181947, 1634752),
  (1635792, 3194496),
  (1634085, 3198034),
  (1634085, 3194774),
  (1634085, 3194080),
  (1634752, 3181947),
  (4127500, 1633754),
  (4127610, 1635410),
  (4130413, 1634049),
  (4121054, 1633306),
  (4129913, 1635790),
  (4128454, 1633565),
  (4128455, 1635611),
  (718590, 1634353),
  (4130411, 1634494),
  (4193457, 1634019),
  (4196557, 1635020),
  (4127607, 1634868),
  (4196564, 1635474),
  (4106768, 1634209),
  (4127501, 1634123),
  (4128450, 1634028),
  (4127608, 1634903),
  (4121176, 1633650),
  (4128456, 1635855),
  (4129914, 1634411),
  (4128457, 1634150),
  (4123017, 1633308),
  (4129915, 1633439),
  (4130412, 1633748),
  (4196439, 1633675),
  (4127502, 1633373),
  (4127503, 1634804),
  (4128451, 1634256),
  (4130409, 1635686),
  (4129910, 1634762),
  (4127504, 1635309),
  (4130410, 1635672),
  (4164075, 1634816),
  (4128453, 1634745),
  (4127606, 1634022),
  (1633754, 4127500),
  (1635410, 4127610),
  (1634049, 4130413),
  (1633306, 4121054),
  (1635790, 4129913),
  (1633565, 4128454),
  (1635611, 4128455),
  (1634353, 718590),
  (1634494, 4130411),
  (1634019, 4193457),
  (1635020, 4196557),
  (1634868, 4127607),
  (1635474, 4196564),
  (1634209, 4106768),
  (1634123, 4127501),
  (1634028, 4128450),
  (1634903, 4127608),
  (1633650, 4121176),
  (1635855, 4128456),
  (1634411, 4129914),
  (1634150, 4128457),
  (1633308, 4123017),
  (1633439, 4129915),
  (1633748, 4130412),
  (1633675, 4196439),
  (1633373, 4127502),
  (1634804, 4127503),
  (1634256, 4128451),
  (1635686, 4130409),
  (1634762, 4129910),
  (1635309, 4127504),
  (1635672, 4130410),
  (1634816, 4164075),
  (1634745, 4128453),
  (1634022, 4127606),
  (45876316, 1634960),
  (45880108, 1635232),
  (45884285, 1634789),
  (46237084, 1635428),
  (45878382, 1633859),
  (45880980, 1634252),
  (45880986, 1633373),
  (45881605, 1635865),
  (45878395, 1633356),
  (45878652, 1633591),
  (45880979, 1633702),
  (45882494, 1635454),
  (45882496, 1634955),
  (46237085, 1634124),
  (45878383, 1633891),
  (45880109, 1634688),
  (45880978, 1633519),
  (46237998, 1635363),
  (45881606, 1633717),
  (45881608, 1635372),
  (45884283, 1634629),
  (45884284, 1633542),
  (46237079, 1635175),
  (46237488, 1633718),
  (45876314, 1635567),
  (45882495, 1634719),
  (45876315, 1633577),
  (45876317, 1633869),
  (46237997, 1633296),
  (46238004, 1633961),
  (45878643, 1635566),
  (45881607, 1635882),
  (45882497, 1633813),
  (46237073, 1633568),
  (45876316, 1635486),
  (45880108, 1635450),
  (45884285, 1635764),
  (46237084, 1634917),
  (46237479, 1635253),
  (45878382, 1635056),
  (45880113, 1633396),
  (45880980, 1635199),
  (45880986, 1633373),
  (45881605, 1635434),
  (45881619, 1634674),
  (45878387, 1633921),
  (45878395, 1633356),
  (45878651, 1635594),
  (45878652, 1634813),
  (45880979, 1633841),
  (45882496, 1633707),
  (46237068, 1634350),
  (45878383, 1634671),
  (45880109, 1634447),
  (45880978, 1634922),
  (46237478, 1633489),
  (46237998, 1635363),
  (46237999, 1635115),
  (45881608, 1634571),
  (45884283, 1635293),
  (45884284, 1634502),
  (46238000, 1634384),
  (45876314, 1635404),
  (45880112, 1635666),
  (45882501, 1635553),
  (45876315, 1634525),
  (46237081, 1633418),
  (45878643, 1634876),
  (45882497, 1634332),
  (46237073, 1635482),
  (1634960, 45876316),
  (1635232, 45880108),
  (1634789, 45884285),
  (1635428, 46237084),
  (1633859, 45878382),
  (1634252, 45880980),
  (1633373, 45880986),
  (1635865, 45881605),
  (1633356, 45878395),
  (1633591, 45878652),
  (1633702, 45880979),
  (1635454, 45882494),
  (1634955, 45882496),
  (1634124, 46237085),
  (1633891, 45878383),
  (1634688, 45880109),
  (1633519, 45880978),
  (1635363, 46237998),
  (1633717, 45881606),
  (1635372, 45881608),
  (1634629, 45884283),
  (1633542, 45884284),
  (1635175, 46237079),
  (1633718, 46237488),
  (1635567, 45876314),
  (1634719, 45882495),
  (1633577, 45876315),
  (1633869, 45876317),
  (1633296, 46237997),
  (1633961, 46238004),
  (1635566, 45878643),
  (1635882, 45881607),
  (1633813, 45882497),
  (1633568, 46237073),
  (1635486, 45876316),
  (1635450, 45880108),
  (1635764, 45884285),
  (1634917, 46237084),
  (1635253, 46237479),
  (1635056, 45878382),
  (1633396, 45880113),
  (1635199, 45880980),
  (1633373, 45880986),
  (1635434, 45881605),
  (1634674, 45881619),
  (1633921, 45878387),
  (1633356, 45878395),
  (1635594, 45878651),
  (1634813, 45878652),
  (1633841, 45880979),
  (1633707, 45882496),
  (1634350, 46237068),
  (1634671, 45878383),
  (1634447, 45880109),
  (1634922, 45880978),
  (1633489, 46237478),
  (1635363, 46237998),
  (1635115, 46237999),
  (1634571, 45881608),
  (1635293, 45884283),
  (1634502, 45884284),
  (1634384, 46238000),
  (1635404, 45876314),
  (1635666, 45880112),
  (1635553, 45882501),
  (1634525, 45876315),
  (1633418, 46237081),
  (1634876, 45878643),
  (1634332, 45882497),
  (1635482, 46237073),
  (35919468, 1634629),
  (35919532, 1633577),
  (35919887, 1633519),
  (35919075, 1633717),
  (35919280, 1635175),
  (35919467, 1634960),
  (35919723, 1633296),
  (35919761, 1635372),
  (35919866, 1634789),
  (35919086, 1634719),
  (35919447, 1634688),
  (35919469, 1633718),
  (35919649, 1634063),
  (35919295, 1633869),
  (35919511, 1635865),
  (35919522, 1633591),
  (35919551, 1633891),
  (35919154, 1635232),
  (35919571, 1633702),
  (35919695, 1634955),
  (35919776, 1633859),
  (35919088, 1634252),
  (35919249, 1633813),
  (35919331, 1633542),
  (35919560, 1635882),
  (35919707, 1633961),
  (35919875, 1635365),
  (35919110, 1635566),
  (35919421, 1635567),
  (35919662, 1635454),
  (35919029, 1634922),
  (35919288, 1635115),
  (35919592, 1635404),
  (35919772, 1633489),
  (35919208, 1633618),
  (35919580, 1633418),
  (35919625, 1635199),
  (35919243, 1634447),
  (35919572, 1633841),
  (35919676, 1635056),
  (35919191, 1633707),
  (35919890, 1635434),
  (35919323, 1633948),
  (35919400, 1634350),
  (35919535, 1635253),
  (35919732, 1634794),
  (35919047, 1634502),
  (35919204, 1634927),
  (35919636, 1634384),
  (35919878, 1634332),
  (35919065, 1634876),
  (35919193, 1635486),
  (35919230, 1634671),
  (35919361, 1635450),
  (35919378, 1635293),
  (35919828, 1634525),
  (35919093, 1635764),
  (35919239, 1634813),
  (35919537, 1635184),
  (35919810, 1634571),
  (35919901, 1635594),
  (35919521, 1635594),
  (1634629, 35919468),
  (1633577, 35919532),
  (1633519, 35919887),
  (1633717, 35919075),
  (1635175, 35919280),
  (1634960, 35919467),
  (1633296, 35919723),
  (1635372, 35919761),
  (1634789, 35919866),
  (1634719, 35919086),
  (1634688, 35919447),
  (1633718, 35919469),
  (1634063, 35919649),
  (1633869, 35919295),
  (1635865, 35919511),
  (1633591, 35919522),
  (1633891, 35919551),
  (1635232, 35919154),
  (1633702, 35919571),
  (1634955, 35919695),
  (1633859, 35919776),
  (1634252, 35919088),
  (1633813, 35919249),
  (1633542, 35919331),
  (1635882, 35919560),
  (1633961, 35919707),
  (1635365, 35919875),
  (1635566, 35919110),
  (1635567, 35919421),
  (1635454, 35919662),
  (1634922, 35919029),
  (1635115, 35919288),
  (1635404, 35919592),
  (1633489, 35919772),
  (1633618, 35919208),
  (1633418, 35919580),
  (1635199, 35919625),
  (1634447, 35919243),
  (1633841, 35919572),
  (1635056, 35919676),
  (1633707, 35919191),
  (1635434, 35919890),
  (1633948, 35919323),
  (1634350, 35919400),
  (1635253, 35919535),
  (1634794, 35919732),
  (1634502, 35919047),
  (1634927, 35919204),
  (1634384, 35919636),
  (1634332, 35919878),
  (1634876, 35919065),
  (1635486, 35919193),
  (1634671, 35919230),
  (1635450, 35919361),
  (1635293, 35919378),
  (1634525, 35919828),
  (1635764, 35919093),
  (1634813, 35919239),
  (1635184, 35919537),
  (1634571, 35919810),
  (1635594, 35919901),
  (1635594, 35919521)
),
vocab_domain(vocabulary_id, domain_id) as (
  values
    ('Cancer Modifier', 'Measurement'),
    ('CDT', 'Device'),
    ('CDT', 'Procedure'),
    ('CPT4', 'Measurement'),
    ('CPT4', 'Observation'),
    ('CPT4', 'Procedure'),
    ('CVX', 'Drug'),
    ('HCPCS', 'Device'),
    ('HCPCS', 'Measurement'),
    ('HCPCS', 'Observation'),
    ('HCPCS', 'Procedure'),
    ('HemOnc', 'Episode'),
    ('ICD10', 'Condition'),
    ('ICD10PCS', 'Procedure'),
    ('ICD9Proc', 'Procedure'),
    ('ICDO3', 'Condition'),
    ('ICDO3', 'Observation'),
    ('LOINC', 'Meas Value'),
    ('LOINC', 'Measurement'),
    ('LOINC', 'Observation'),
    ('OMOP Extension', 'Observation'),
    ('OMOP Genomic', 'Measurement'),
    ('OPCS4', 'Procedure'),
    ('RxNorm', 'Drug'),
    ('RxNorm Extension', 'Drug'),
    ('SNOMED', 'Condition'),
    ('SNOMED', 'Device'),
    ('SNOMED', 'Meas Value'),
    ('SNOMED', 'Measurement'),
    ('SNOMED', 'Observation'),
    ('SNOMED', 'Procedure')
),
d(domain, is_domain) as (
  values
    ('i', 'Episode'),
    ('d', 'Drug'),
    ('e', 'Device'),
    ('p', 'Procedure'),
    ('c', 'Condition'),
    ('o', 'Observation'),
    ('m', 'Measurement'),
    ('v', 'Meas Value')
),
cst as (
  select standard as concept_id, is_domain, 
    case 
      when standard=0 then 'Concept 0'
      when standard in (439386, 602269, 602272, 602275, 602969, 602970, 602971, 604547, 607048, 607049, 607050, 607051, 607053, 607054, 607055, 607056, 607057, 607058, 607059, 607060, 607061, 607062, 607063, 607064, 607065, 607066, 607067, 607068, 607069, 607280, 609311, 618469, 619436, 763789, 763790, 763791, 764843, 764844, 764845, 765765, 765766, 765927, 1616648, 3019275, 3031227, 3046328, 3047285, 3170524, 3178338, 3181947, 3186481, 3187219, 3190559, 3190559, 3191997, 3192778, 3194080, 3194224, 3194224, 3194496, 3194496, 3194774, 3195575, 3196195, 3196710, 3196710, 3198034, 3198481, 3655244, 3655245, 3655246, 3655247, 3655248, 4041008, 4054711, 4074238, 4077696, 4086970, 4120176, 4140825, 4157601, 4159955, 4160340, 4161012, 4161056, 4161667, 4164609, 4172456, 4183079, 4183080, 4183081, 4183082, 4183477, 4183904, 4183905, 4183906, 4183907, 4183908, 4184071, 4190072, 4190073, 4190075, 4194837, 4194838, 4196566, 4197325, 4204361, 4211973, 4213274, 4218365, 4218367, 4224785, 4233916, 4240067, 4240465, 4240570, 4240677, 4241072, 4241172, 4241295, 4241297, 4241299, 4245718, 4246265, 4246266, 4246267, 4250166, 4262472, 4263000, 4263220, 4263969, 4264626, 4264742, 4287178, 4287179, 4293037, 4294060, 4296693, 4297708, 4297709, 4314170, 35914128, 35917160, 35917178, 35917462, 35917557, 35917660, 35917676, 35917681, 35917685, 35917726, 35917728, 35917765, 35917822, 35917910, 35917927, 35917950, 35918077, 35918085, 35918197, 35918328, 35918437, 35918519, 35918542, 35918640, 35918842, 35919509, 35919618, 35919728, 35919765, 35919954, 35919970, 35919994, 35920028, 35920085, 35920126, 35920143, 35920146, 35920179, 35920224, 35920251, 35920260, 35920270, 35920343, 35920443, 35920539, 35920573, 35920610, 35920655, 35920824, 35920860, 35920989, 35921091, 35921109, 35921133, 35921137, 35921152, 35921160, 35921178, 35921183, 35921196, 35921230, 35921250, 35921264, 35921328, 35921353, 35921403, 35921405, 35921656, 35921661, 35921723, 35921747, 35921784, 35921870, 35921886, 35921901, 35922090, 35922140, 35922141, 35922150, 35922156, 35922174, 35922242, 35922266, 35922313, 35922337, 35922348, 35922355, 35922383, 35922400, 35922411, 35922447, 35922505, 35922591, 35922626, 35922682, 35922730, 35922904, 35922962, 35922988, 35922993, 35923048, 35923057, 35923088, 35923118, 35923132, 35923135, 35923201, 35923253, 35923337, 35923339, 35923388, 35923524, 35923553, 35923649, 35923741, 35923810, 35923852, 35923904, 35923915, 35923956, 35923977, 35923982, 35923983, 35924009, 35924031, 35924039, 35924130, 35924162, 35924188, 35924254, 35924257, 35924261, 35924267, 35924286, 35924411, 35924416, 35924479, 35924520, 35924543, 35924603, 35924622, 35924848, 35924881, 35924927, 35924949, 35925068, 35925128, 35925158, 35925362, 35925383, 35925568, 35925589, 35925615, 35925622, 35925690, 35925742, 35925857, 35925969, 35926128, 35926215, 35926216, 35926224, 35926278, 35926329, 35926364, 35926523, 35926594, 35926609, 35926836, 35926865, 35926871, 35926933, 35926948, 35926976, 35926992, 35927009, 35927163, 35927190, 35927208, 35927238, 35927240, 35927266, 35927285, 35927297, 35927351, 35927402, 35927464, 35927466, 35927674, 35927738, 35927757, 35927863, 35927939, 35927962, 35928107, 35928108, 35928255, 35928266, 35928291, 35928350, 35928360, 35928384, 35928409, 35928475, 35928496, 35928540, 35928541, 35928600, 35928621, 35928825, 35928832, 35928840, 35928955, 35928990, 35929019, 35929086, 35929088, 35929132, 35929144, 35929264, 35929318, 35929322, 35929414, 35929419, 35929474, 35929477, 35929479, 35929500, 35929512, 35929527, 35929742, 35929799, 35929801, 35929813, 35929857, 35929938, 35930010, 35930018, 35930198, 35930199, 35930331, 35930359, 35930379, 35930406, 35930456, 35930465, 35930532, 35930554, 35930575, 35930611, 35930625, 35930700, 35930717, 35930746, 35930783, 35930798, 35930874, 35930901, 35930915, 35930967, 35930977, 35930994, 35931147, 35931164, 35931194, 35931232, 35931301, 35931401, 35931460, 35931498, 35931542, 35931655, 35931686, 35931701, 35931717, 35931744, 35931796, 35931886, 35931985, 35932083, 35932257, 35932339, 35932470, 35932517, 35932624, 35932669, 35932747, 35932754, 35932784, 35932786, 35932956, 35932979, 35933036, 35933064, 35933129, 35933192, 35933195, 35933201, 35933238, 35933290, 35933300, 35933312, 35933317, 35933320, 35933340, 35933343, 35933399, 35933414, 35933450, 35933462, 35933469, 35933533, 35933606, 35933617, 35933638, 35933735, 35933764, 35934022, 35934034, 35934043, 35934104, 35934134, 35934154, 35934160, 35934218, 35934266, 35934292, 35934294, 35934374, 35934376, 35934400, 35934404, 35934440, 35934480, 35934510, 35934669, 35934680, 35934757, 35934768, 35934826, 35934875, 35934878, 35934974, 35935005, 35935009, 35935013, 35935147, 35935177, 35935326, 35935359, 35935396, 35935422, 35935509, 35935511, 35935545, 35935547, 35935582, 35935691, 35935721, 35935766, 35936070, 35936088, 35936096, 35936235, 35936237, 35936259, 35936291, 35936301, 35936327, 35936389, 35936429, 35936455, 35936559, 35936579, 35936591, 35936611, 35936624, 35936690, 35936705, 35936724, 35936833, 35936834, 35936839, 35936893, 35936942, 35936961, 35936979, 35937095, 35937128, 35937171, 35937204, 35937307, 35937340, 35937404, 35937557, 35937649, 35937667, 35937741, 35937750, 35937792, 35937813, 35937967, 35937993, 35938036, 35938083, 35938153, 35938161, 35938167, 35938215, 35938242, 35938257, 35938280, 35938376, 35938420, 35938653, 35938675, 35938716, 35938780, 35938994, 35939129, 35939253, 35939279, 35939323, 35939341, 35939364, 35939419, 35939481, 35939553, 35939570, 35939580, 35939601, 35939604, 35939647, 35939679, 35939717, 35939751, 35939852, 35939934, 35940098, 35940140, 35940143, 35940158, 35940179, 35940207, 35940308, 35940518, 35941810, 36210138, 36210185, 36210716, 36660173, 36660206, 40762603, 40762604, 40769829, 40769833, 45876292, 45878362, 45878621, 45878622, 45880086, 45880955, 45880956, 45881581, 45881582, 45882267, 45884263, 45884439, 45885239, 45885240) then 'Invalid grade'
      when standard in (718590, 3188117, 4106768, 4121054, 4121176, 4123017, 4127500, 4127501, 4127502, 4127503, 4127504, 4127505, 4127506, 4127606, 4127607, 4127608, 4127609, 4127610, 4128450, 4128451, 4128452, 4128453, 4128454, 4128455, 4128456, 4128457, 4129910, 4129912, 4129913, 4129914, 4129915, 4130406, 4130407, 4130408, 4130409, 4130410, 4130411, 4130412, 4130413, 4164075, 4193457, 4196439, 4196557, 4196564, 35919029, 35919047, 35919065, 35919075, 35919086, 35919088, 35919093, 35919110, 35919154, 35919191, 35919193, 35919204, 35919208, 35919230, 35919239, 35919243, 35919249, 35919280, 35919288, 35919295, 35919323, 35919331, 35919361, 35919378, 35919400, 35919421, 35919447, 35919467, 35919468, 35919469, 35919511, 35919521, 35919522, 35919532, 35919533, 35919535, 35919537, 35919551, 35919560, 35919571, 35919572, 35919580, 35919592, 35919625, 35919636, 35919649, 35919662, 35919676, 35919695, 35919707, 35919723, 35919732, 35919761, 35919772, 35919776, 35919810, 35919828, 35919835, 35919866, 35919875, 35919878, 35919887, 35919890, 35919901, 45876314, 45876314, 45876315, 45876315, 45876316, 45876316, 45876317, 45877986, 45878382, 45878382, 45878383, 45878383, 45878387, 45878395, 45878395, 45878643, 45878643, 45878651, 45878652, 45878652, 45878653, 45880108, 45880108, 45880109, 45880109, 45880112, 45880113, 45880978, 45880978, 45880979, 45880979, 45880980, 45880980, 45880981, 45880981, 45880986, 45880986, 45881605, 45881605, 45881606, 45881607, 45881608, 45881608, 45881619, 45882494, 45882495, 45882496, 45882496, 45882497, 45882497, 45882501, 45884283, 45884283, 45884284, 45884284, 45884285, 45884285, 46237068, 46237073, 46237073, 46237079, 46237081, 46237084, 46237084, 46237085, 46237085, 46237478, 46237479, 46237488, 46237997, 46237998, 46237998, 46237999, 46238000, 46238004, 46238005, 46238005) then 'Invalid stage'
      when standard in (40320642, 40352613, 40385299, 40320630, 40352607, 40390367, 40385463, 44801366, 40385466, 44797724, 40385831, 44795663, 40385468, 44799337, 40385832, 44797168, 40385467, 44797725, 40385833, 44801443, 4245720, 4270465, 4288239, 608940, 608946, 602334, 608979, 602333, 608866, 608930, 608931, 3575243, 4190930, 4299133, 40385748, 44833472, 4164481, 4163446, 35624616, 40390759, 602260, 44793886, 4228790, 4249699, 4240560, 4241933, 4241552, 4184079, 4183211, 4183478, 4241934, 4241060, 4241935, 4184076, 4183480, 759938, 764972, 44830990, 37018661, 4183632, 4182918, 4183744, 4182919, 4183745, 4183914, 4182920, 4183339, 4289377, 4281017, 4283615, 4281018, 4289098, 4283737, 4289378, 4281034, 4289687, 4283751, 4283752, 4182921, 4289516, 4283753, 4281036, 4281037, 4283880, 4289692, 40390374, 4289823, 4289521, 4289381, 4289248, 4283612, 4289093, 4289249, 4289094, 4283613, 4289095, 4289686, 4283877, 4289690, 4289519, 4281035, 4283878, 4283879, 4281160, 44801657, 4289824, 4281161, 4289825, 4289826, 4289523, 4289382, 4283741, 4289252, 4280898, 4289096, 4283743, 40385394, 4289386, 44800546, 40390740, 44799551, 4263459, 4265295, 2106924, 4194691, 4183217, 40756842, 1030309, 1004176, 1004177, 1004178, 1004179, 1030311, 1004182, 1004185, 1004186, 40769838, 40769842, 4099633, 37078044, 1030459, 1030460, 1030461, 45890688, 4281162, 4283744, 4283881, 4283882, 1567619, 4289524, 4283883, 1567622, 4281164, 1567624, 4283884, 1567626, 4281165, 1567628, 4281166, 4283885, 4283886, 1616704, 1618178, 915671, 1620371, 1620738, 1621181, 1014780, 4119047, 4289380, 4283888, 4183628, 4183335, 4183629, 4183630, 4183336, 4297801, 40520895, 4299325, 4200893, 4196260, 4196263, 4196259, 4198446, 4201020, 4201623, 4201014, 4196264, 4198445, 4198444, 4201617, 4196266, 4201621, 4201015, 4196262, 4201618, 4200894, 4196258, 4201620, 4201622, 4263142, 3006575, 3007073, 3018082, 3031522, 3034923, 3042868, 3046131, 3046179, 3046523, 4196267, 4196261, 4297349, 4118499, 4119001, 4134624, 4120185, 4123148, 4120186, 4080545, 4112781, 4112490, 40320638, 4112777, 4112780, 4110019, 4112482, 4110013, 4166589, 4110135, 4123439, 40320621, 4112771, 40320623, 40320627, 40320622, 40320634, 4110134, 4112772, 40320633, 40381908, 43530694, 4110014, 40320631, 43530696, 4112770, 40320620, 43531596, 4162254, 37025385, 43530697, 4112491, 4112483, 4123440, 40320628, 4116348, 40320639, 40385751, 4112489, 4112774, 4111031, 4112776, 4116575, 4112773, 4116246, 4116577, 40320635, 40385736, 4112488, 4109233, 40456809, 4110018, 4112775, 4116576, 4112650, 4112779, 4110133, 4116578, 4145870, 4291148, 37019559, 3964807, 37040031, 37060116, 36684947, 36684950, 37077014, 3968377, 4104214, 432631, 36684946, 37042857, 4084577, 4126828, 4084147, 765459, 763113, 762892, 763111, 762895, 1034401, 762896, 763116, 763001, 763118, 763117, 763115, 763103, 765662, 762905, 763124, 763125, 763123, 763122, 765863, 765906, 762902, 762903, 765864, 765512, 762904, 763130, 763131, 763132, 763134, 763133, 763128, 763129, 37016150, 37018877, 37208188, 2618018, 2618020, 2618019, 2618021, 2618022, 2618032, 2618036, 2618037, 2618034, 2618035, 4313066, 2618045, 2618009, 2617997, 2617998, 2617999, 4004515, 4157460, 4129285, 40287680, 4129938, 2618000, 4134634, 2618002, 2618047, 2618048, 2618049, 2618039, 2618040, 2618041, 2618016, 2618011, 2618012, 2618013, 2618066, 2618067, 2618028, 2618003, 37081416, 45571543, 3663237, 4129622, 4029023, 37111473, 4224153, 4160907, 4223201, 4265009, 4287478, 4168514, 602256, 4288669, 4223202, 4264263, 4188640, 4298500, 45768670, 4164018, 4215394, 4287188, 4141536, 4249709, 4246703, 4215393, 4216012, 4245129, 4263799, 4265302, 4161544, 4286895, 4264288, 4216013, 4219028, 4139997, 4253004, 4264600, 4245942, 4219190, 4264861, 4245130, 4187867, 4336816, 40552094, 4230027, 40552095, 4230028, 40552096, 4230150, 40552097, 4235556, 4158682, 4264455, 4264587, 4245838, 4227242, 4229871, 4265019, 4288096, 4288095, 4265020, 4160793, 4217716, 4299310, 4263653, 4245581, 4245241, 4297710, 4288685, 46270968, 4299198, 4287483, 4263798, 4264264, 4262994, 4246388, 4245127, 4160795, 4246370, 4287031, 4163561, 4262741, 4264120, 4187864, 4263146, 4164165, 4187865, 4129935, 4264121, 4160794, 4158683, 4265021, 4264588, 4262995, 4246389, 4245128, 4216801, 4187866, 4295631, 4263007, 4244835, 4265024, 4295517, 4298501, 4263130, 4288686, 4160904, 4263654, 4245940, 4160905, 4262993, 4262992, 4262742, 4262996, 4164472, 4263655, 4245941, 4295632, 4300130, 4265025, 4293155, 4245600, 4158684, 4245481, 4246160, 4158685, 4160906, 37016740, 764971, 4221383, 4164162, 4288237, 4265421, 4221086, 4287475, 4213276, 4245114, 4288238, 4219605, 4221386, 4287632, 4221518, 4163438, 4257442, 4299134, 40385732, 604497, 36712980, 36716990, 759982, 608941, 608928, 600834, 608942, 608927, 608852, 3519757, 4091627, 3532988, 4091629, 3567548, 4097419, 35206322, 3582188, 4094400, 3531110, 4091754, 3565761, 4091632, 4097418, 3582243, 4097423, 3582155, 4245947, 3531227, 4096824, 3519758, 4097413, 3531231, 4094401, 3582586, 4091624, 3532224, 4094395, 3582102, 4091633, 3582588, 4091626, 3531487, 4096826, 3531448, 4094398, 3519478, 4091631, 3519466, 4097420, 3531229, 4096825, 35206323, 3582241, 4091757, 3582354, 4097416, 3582242, 4097422, 3582416, 4097415, 3531442, 4097417, 35206321, 44821737, 3571014, 4091634, 3531837, 4094402, 35206324, 44833307, 3531488, 4094403, 3566636, 4091628, 35206320, 44834501, 3582070, 4096823, 35206326, 1567618, 3573598, 4153429, 37093670, 44836847, 3531489, 4096828, 3531490, 4091758, 44821738, 3530937, 4097411, 35206319, 3582590, 4097414, 44832135, 44829821, 35206325, 44828745, 44836848, 3582755, 4096821, 3531160, 4097424, 3519754, 4097412, 3582126, 4096822, 3569520, 4097421, 3531836, 4091756, 3582519, 4094396, 3582383, 46271138, 4096827, 3519756, 46273704, 4091625, 3582756, 4094394, 4262748, 3582211, 4094277, 3531230, 4091755, 3531447, 4094397, 3531564, 36684856, 4094276, 4263144, 3582520, 45771486, 4091630, 3582103, 4094399, 37093674, 37093675, 4263814, 37093673, 37093676, 37093672, 37093678, 37093671, 37093677, 1567614, 45542633, 45552289, 45542632, 45600534, 45532941, 45532940, 3542229, 4117043, 192269, 46271139, 3542169, 4111032, 4113113, 4266491, 3661467, 4300779, 46270936, 4114341, 3535048, 4111387, 608945, 619828, 608947, 37093681, 4312037, 4311630, 4311631, 4312038, 4312039, 4312699, 4311632, 4311633, 4246251, 193144, 1567630, 37081411, 44828746, 4246253, 4312040, 4311634, 4312700, 4312041, 35610151, 4312701, 4312148, 4246347, 4312702, 4312149, 4312703, 4246349, 40651438, 4311635, 4246350, 4311636, 4246351, 4027231, 4181016, 4287028, 4312150, 4312151, 442252, 4162133, 4246352, 4311637, 4312705, 36712822, 760916, 766340, 4311638, 4312802, 45600527, 1567625, 37081405, 4312276, 4311746, 40651453, 4312152, 4311747, 4312803, 4246354, 4246355, 4312804, 4312805, 4246356, 4246357, 4246358, 40651896, 4220182, 4311756, 4312165, 4312820, 4312166, 4311757, 4312821, 4246367, 4311758, 4311759, 4312167, 4266182, 4312275, 4246368, 4246369, 4311760, 4312277, 78097, 45552285, 40651916, 37081409, 44834502, 4246450, 45552286, 4312278, 4312279, 4312823, 4311762, 4246451, 45557016, 37081407, 378087, 44836851, 3567182, 4091764, 46271141, 4312280, 603292, 46271142, 44835686, 45542630, 4312824, 4312281, 4312284, 4246452, 4312282, 4246453, 4246454, 4312283, 4312285, 4312825, 4312934, 4312935, 4246455, 4312936, 4312287, 4312937, 4312286, 4312288, 4312938, 4312289, 4312290, 45537843, 4312291, 4311763, 4312939, 4246457, 4091766, 4312940, 4311764, 4246458, 4312293, 35610160, 4312941, 4247943, 4247944, 4247945, 35610158, 4311765, 40385369, 36683301, 4312943, 4247946, 4311766, 37093680, 37093679, 4312945, 4312946, 4311767, 4311768, 4312947, 4247947, 35610150, 35610159, 4311875, 4311876, 35610155, 4312295, 442188, 40385363, 4312296, 4311877, 4312297, 4247949, 4311878, 4311879, 4312299, 4312948, 4096952, 4312949, 4312950, 4311880, 4312300, 4312951, 4312952, 4311881, 4312301, 4312954, 4312955, 4312956, 4312957, 4312302, 140960, 201240, 4312303, 4313077, 4247960, 4311895, 4312423, 4313078, 4311896, 4311897, 4312013, 4312014, 4312015, 4247961, 4313079, 4247962, 608735, 44836852, 4312425, 4313080, 4313081, 4312426, 4247963, 4312427, 4247964, 4247965, 4312016, 4313082, 4247966, 4313083, 4312017, 4247967, 4312018, 4312429, 4248055, 4313085, 4313086, 4313087, 4248056, 4248057, 40385365, 4313088, 4312019, 35610157, 4312020, 194585, 4313089, 4248058, 4313090, 4248059, 4248060, 35610162, 35610148, 4312430, 4312022, 192568, 4312023, 4312024, 200959, 439751, 4248061, 4248062, 4248063, 4248064, 4313091, 4313092, 40385364, 4312540, 4248065, 196053, 44824037, 37081404, 4248066, 4248067, 4302810, 40464349, 40645478, 4313206, 4308759, 200348, 3543784, 37081399, 40385367, 40492474, 44835683, 3519482, 4091760, 4248068, 4313207, 4248069, 4313208, 4312026, 40651924, 4313209, 4312027, 4312028, 4313210, 601143, 45605289, 602331, 608981, 4281024, 605437, 4313211, 45552281, 46273652, 4281027, 45571541, 4128110, 4313212, 4313788, 607797, 4312542, 4248070, 4313789, 198700, 37081401, 44806773, 4313214, 4313215, 4312543, 4312544, 42709760, 4312545, 4312546, 4313216, 4312547, 46271211, 4248071, 254591, 1567620, 37081394, 44832136, 318096, 36713026, 440341, 442183, 442182, 320342, 442181, 36717298, 434298, 4248073, 4248074, 442178, 442177, 4315537, 4313791, 35610154, 4312548, 4315538, 4248076, 4313792, 434875, 35206327, 37081395, 44829822, 4315539, 4313793, 4315540, 4312549, 4248077, 4248078, 4312550, 4248079, 4248182, 4315541, 4313794, 4312551, 4313795, 4312552, 4315542, 4248081, 4248082, 4313796, 4312553, 4312554, 4313797, 4315543, 4312555, 4315544, 4313798, 4312556, 4248183, 4315545, 4055132, 40646016, 4313799, 4315547, 373425, 4248184, 4248185, 4312557, 4312558, 4313801, 4248186, 4248187, 4312559, 4248189, 4314487, 4248190, 4312560, 4313802, 37081402, 1567627, 37081408, 1567621, 37081397, 1567623, 37081403, 3519525, 4096948, 44836849, 3532360, 4091765, 44833309, 45532937, 3530935, 4096829, 44824036, 45557015, 3583608, 4094407, 40385759, 1567631, 3541083, 4154631, 37081412, 40385752, 44826416, 44828747, 44836850, 45532939, 3519755, 4096950, 3519484, 4091761, 44835685, 199752, 1567629, 37081410, 44834503, 4315548, 4248191, 4248192, 4315550, 4315552, 4315553, 4248193, 4315657, 4313803, 4248194, 4313911, 35610147, 4248195, 4313912, 4312561, 4313913, 4312562, 4248197, 4315658, 4315659, 4312563, 4248198, 4313914, 4313915, 4313916, 4313917, 4313918, 4315661, 4248199, 4248200, 4315805, 4315662, 4313919, 4315663, 4311208, 4312564, 4311209, 4311210, 72266, 35206328, 37081396, 44833308, 4311211, 4313920, 4313921, 4313922, 4311212, 4315664, 4314336, 4311320, 4312012, 4315666, 4314337, 4315667, 4311321, 4314338, 4315668, 4313924, 4311322, 4314339, 4311323, 4313925, 442174, 40385370, 4315670, 37081393, 4147162, 44819442, 40385360, 3531492, 4096949, 253717, 4311324, 4315671, 4314340, 4315672, 4315806, 196925, 37081400, 44835684, 3563896, 4097425, 4314341, 4311326, 601141, 45576343, 602332, 608980, 4289680, 602668, 4313926, 45537840, 46271143, 46270513, 4315673, 4281030, 45542629, 4314342, 4315674, 35610156, 4311327, 4314343, 4315675, 4315546, 4311328, 35206330, 35206331, 35206332, 4314344, 4301388, 764449, 1024759, 4032806, 4314345, 4314346, 4311329, 4283739, 4313927, 4313928, 4314347, 4314348, 4315677, 136354, 35206333, 37081406, 44821739, 3530971, 4091763, 36203174, 36203175, 36203182, 36205774, 45766888, 36206484, 36208335, 36209183, 36210146, 36210382, 36210725, 36310598, 36311298, 4314349, 4314350, 763049, 4313929, 4313930, 4315678, 4313931, 40385743, 4315679, 4311331, 4311332, 4313932, 4315680, 4315681, 4313933, 4313934, 4315683, 4315684, 40385738, 4315685, 4315686, 4313935, 4311333, 4091275, 37019862, 37020577, 37023301, 46270937, 37035551, 1314511, 1314515, 1314507, 37061519, 37070670, 37070802, 37074427, 37075956, 4314351, 4314352, 4091762, 4315793, 4094406, 3654229, 4311334, 4314353, 4311335, 42709758, 4315794, 4315795, 40385739, 4314354, 4313936, 4311336, 4311337, 4314355, 4097426, 4314356, 4314357, 4314358, 4313937, 40385740, 4314359, 42709759, 4314360, 4315796, 198371, 35206329, 37081398, 40385362, 44830989, 3565386, 4094405, 4311339, 602316, 602282, 4312944, 4314361, 4214371, 1619237, 1015305, 1031017, 4163000, 4315797, 4314362, 4315798, 4311340, 4315799, 4313939, 4315800, 4314046, 4314478, 4311341, 4314479, 4315801, 4314047, 4314480, 4314048, 4314049, 4314050, 4311342, 4314481, 442173, 4314052, 4311344, 4314053, 4314482, 4314483, 4311345, 4314484, 4314054, 37116980, 35610152, 4314055, 4314056, 4314485, 4314057, 4314058, 35610149, 4311346, 4311347, 4314059, 4315804, 4314486, 4314061, 4311348, 37081414, 37081413, 4314062, 4314063, 37081415, 4315807, 4311349, 4315808, 37116979, 3545386, 40548259, 4247948, 4311472, 4314488, 4315809, 40479359, 40479400, 40479812, 40479814, 4315810, 4314489, 40481946, 4314065, 4311473, 40385757, 40514771, 4315549, 4161021, 4314066, 4314490, 4313217, 4314067, 4314068, 4315811, 4314069, 4313218, 4314491, 4314070, 4314071, 4314492, 37037662, 40762537, 40762538, 40762539, 40762540, 40762543, 40762546, 40762547, 4299435, 36205776, 42527701, 42527713, 42527716, 42530626, 4315812, 4158910, 40385767, 45576342, 45605288, 45586027, 45561834, 45561833, 3006171, 45542628, 920115, 45595689, 42709761, 4314493, 1031084, 3042814, 4314072, 4314073, 4271714, 4314189, 1031116, 4314190, 4313220, 4313221, 4314191, 4313222, 4315813, 4314494, 78987, 4313223, 40651955, 4314495, 4313224, 4315814, 4313225, 4314496, 4314192, 4314193, 4314497, 4315815, 4314498, 4314194, 4315802, 4314195, 4314196, 37310458, 4314499, 4314500, 4314197, 4313226, 40385754, 40456812, 4314198, 4314199, 37093682, 432851, 44828764, 45566619, 4289393, 4289684, 761027, 44832171, 44831024, 44836885, 44828765, 44827595, 44827594, 1567613, 45890917, 45537842, 608896, 600854, 600835, 608929, 619829, 608944, 608933, 608855, 45552283, 600852, 608943, 608932, 600828, 608853, 759974, 759939, 764957, 764956, 4262152, 45576340, 45576341, 4235558, 4240688, 4241178, 4240690, 45600526, 4241546, 45600528, 4241305, 4241179, 4241306, 4161666, 4241181, 4253001, 4260320, 4312667, 4245698, 4287027, 4233917, 4162080, 3032133, 1015308, 1008948, 1008952, 4263143, 4245697, 4233629, 40387079, 40390328, 4123152, 4221342, 36208112, 37039548, 42530874, 42527710, 40664869, 937677, 3031099, 40762542, 40762545, 40762548, 4233788, 4233789, 2213285, 3036515, 36203173, 37038851, 36203183, 36206495, 37038788, 40539090, 4234267, 4240935, 4241926, 4241049, 4241054, 4240938, 4240939, 4241549, 4156593, 4240558, 4240446, 4241932, 4241057, 4184218, 4241050, 4241551, 4241058, 4240559, 4241059, 4240932, 4241815, 4240548, 4240933, 4241924, 4241929, 4240550, 4241927, 4241051, 4241928, 4241053, 4241055, 4240934, 4163763, 4241550, 4240553, 4241930, 4240554, 4240937, 4240552, 4241052, 4241931, 4240555, 4240549, 4241056, 4131424, 762893, 762894, 763110, 763114, 763102, 763100, 763099, 763126, 763127, 4164612, 40483198, 40480175, 607695, 607674, 607678, 603067, 602280, 607685, 607679, 607707, 607693, 607689, 603063, 607712, 607727, 607699, 607774, 607731, 602263, 607741, 607744, 607746, 607750, 607735, 607738, 607702, 607757, 607753, 607778, 607667, 607767, 607664, 607758, 607771, 607706, 607779, 607786, 607772, 607686, 607684, 607682, 4154265, 3662037, 2106805, 40664885, 4245599, 4263129, 4286893, 4286894, 3007727, 3008250, 3013189, 21013349, 37020347, 37073998, 36203178, 36206494, 37049880, 4155618, 3032528, 4240923, 4241434, 4241806, 4241807) then 'Invalid met or node'
      when is_domain!=domain_id then 'Wrong domain table'
      when vocab_domain.vocabulary_id is null then 'Wrong vocab for domain' 
      when standard_concept is null then 'Not standard concept'
      else null 
    end as critique
  from __schema__.general 
  join __cdm_schema__.concept c on c.concept_id=standard
  join d using(domain)
  left join vocab_domain using(vocabulary_id, domain_id)
  where standard is not null
  group by standard, is_domain, standard_concept, domain_id, vocab_domain.vocabulary_id
)
select distinct concept_id, concept_name, vocabulary_id, concept_code, concept_class_id, critique,
  case
    when concept_name ilike '%unknown%' then 'Flavor of NULL'
    when concept_name ilike '%not stated%' then 'Flavor of NULL'
    when stcm.source_id is not null then 'Map to '||map
    when pc is not null then 'Precoordinate with '||pc||' and map'
    when vocabulary_id='Cancer Modifier' and critique='Wrong domain table' then 'Should be '||domain_id||' rather than '||is_domain
    when standard_concept is null or standard_concept='C' then 'Remap to Standard'
    when is_domain='Meas Value' then 'Precoordinate and map'
    when hist.ancestor_concept_id is not null then 'Precoordinate and map' 
    when ss is not null then 'Map to Cancer Modifier'
    when map is not null then 'Map to '||map
    when critique='Wrong domain table' then 'Should be '||domain_id||' rather than '||is_domain 
    when critique='Wrong vocab for domain' then 'Domain '||is_domain 
    else null 
  end as fix
from cst join __cdm_schema__.concept using(concept_id)
left join (select distinct concept_id_1, concept_id_2 as pc from __cdm_schema__.concept_relationship join __cdm_schema__.concept on concept_id=concept_id_2 and vocabulary_id in ('NAACCR', 'LOINC') where relationship_id in ('Has Answer', 'Answer of')) pc on pc.concept_id_1=concept_id  -- see if it needs to be pre-coordinated
left join __cdm_schema__.concept_ancestor hist on hist.descendant_concept_id=concept_id and hist.ancestor_concept_id=4264604 -- histology
left join (select distinct concept_id_1, concept_id_2 as map from __cdm_schema__.concept_relationship where relationship_id='Maps to' and concept_id_1!=concept_id_2) mp on mp.concept_id_1=concept_id  -- see if it needs to be pre-coordinated
left join (select distinct concept_id_1, 1 as ss from __cdm_schema__.concept_relationship join __cdm_schema__.concept_ancestor on concept_id_2=descendant_concept_id and ancestor_concept_id in (4110275, 4297708, 432851) where relationship_id='Maps to' and concept_id_1!=concept_id_2) bs on bs.concept_id_1=concept_id
left join stcm on source_id=concept_id
where critique is not null and concept_id!=0
order by concept_name;



-- 13. Top wrong domain concepts
-- used to be "13 Top wrong domain concepts.csv"
delete from __schema__.top_wrong_domain_concepts;

insert into __schema__.top_wrong_domain_concepts
with cst as (
  select partner, standard, concept_name, vocabulary_id, is_domain, c.domain_id as shouldbe_domain, 
    sum(cnt) as records, round(sum(cnt)*1.0/t_records, 4) as "record_%", count(distinct standard) as concepts, round(count(distinct standard)*1.0/t_standard, 4) as "concepts_%"
  from (
    select partner, standard, cnt, case domain 
      when 'i' then 'Episode'
      when 'd' then 'Drug'
      when 'e' then 'Device'
      when 'p' then 'Procedure'
      when 'c' then 'Condition'
      when 'o' then 'Observation'
      when 'm' then 'Measurement'
      when 'v' then 'Meas Value'
      else ''
    end as is_domain
    from __schema__.general
  ) g join __cdm_schema__.concept c on c.concept_id=g.standard
  join __schema__.records_and_concepts_in_source_and_standard using(partner)
  where domain_id!=is_domain and standard!=0
  group by partner, standard, t_records, t_standard, concept_name, vocabulary_id, c.domain_id, is_domain -- same standard can be more than once b/o different sources
)
select * from cst
order by 1, records desc;


/******************************
Mapping from source to standard
******************************/
-- 14. Count up
-- used to be "14 Mapping from source to standard.csv"
delete from __schema__.mapping_from_source_to_standard;

insert into __schema__.mapping_from_source_to_standard
with should as ( -- source concepts and their correct mappings
  select distinct source
  from __schema__.general
  join __cdm_schema__.concept_relationship on concept_id_1=source and invalid_reason is null and relationship_id='Maps to'
), 
actual as ( -- source-standard pairs that also exist as "Maps to" relationships
  select distinct source, standard
  from __schema__.general
  join __cdm_schema__.concept_relationship on concept_id_1=source and concept_id_2=standard and invalid_reason is null and relationship_id='Maps to'
    and concept_id_1!=concept_id_2
),
cst as (
  select partner, source as source_id, standard, 
    case 
      when source=standard then 'Known'
      when actual.standard is not null then 'Known'
      when should.source is not null then 'Known'
      else 'Unknown'
    end as source, 
    case 
      when actual.standard is not null or source=standard then 'Correct mapping' 
      when should.source is not null then 'Wrong mapping'
      when standard is not null and standard!=0 then 'Self mapping' 
      else 'No mapping'
    end as mapping,
    cnt 
  from __schema__.general left join __cdm_schema__.concept on source=concept_id -- remove 2-billionaires
  left join should using(source)
  left join actual using(source, standard)
--   where source is not null or source!=0 or concept_id is not null
),
cst_summed as (
  select partner, source, mapping, sum(cnt) as records, count(distinct source_id) as concepts
  from (select distinct partner from __schema__.patient) p left join cst using(partner)
  group by partner, source, mapping
),
t as (
  select partner, sum(cnt) as t_records, count(distinct source_id) as t_source
  from cst
  group by partner
)
select partner, source, mapping,
  records, case t_records when 0 then 0 else round(records*1.0/t_records, 4) end as "record_%", 
  concepts, case t_source when 0 then 0 else round(concepts*1.0/t_source, 4) end as "concepts_%"
from cst_summed left join t using(partner)
order by 1, 2;
